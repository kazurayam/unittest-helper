:projectVersion: 0.0.0

= Unit Test Helper

- author: kazurayam
- date: Nov, 2023
- version: {projectVersion}
- source project: link:https://github.com/kazurayam/unittest-helper[]
- javadoc: link:https://kazurayam.github.io/unittest-helper/api[]

== Problems to solve

=== Is Current Working Directory reliable for unit-tests? --- Not always

I encountered some difficulties in a TestNG test case in a Gradle Multi-project. I expected that a call to `System.getProperty("user.dir")` would return the Path of subproject's directory. In most cases, yes. It works fine. But sometimes it failed. See the following post for detail:

- https://github.com/kazurayam/selenium-webdriver-java/issues/22

I couldn't find out the reason why the "current working directory" became the parent project's directory, not the subproject directory.

The following post in the Gradle forum gave me a clue:

- link:https://discuss.gradle.org/t/how-do-i-set-the-working-directory-for-testng-in-a-multi-project-gradle-build/7379/7[Gradle Forums, How do I set the working dreictory for TestNG in a multi-project Gradle build?]

____
luke_daley
Gradle Employee
Nov '13

Loading from the filesystem using relative paths during unit tests is problematic because different environments will set a different working directory for the test process. For example, Gradle uses the projects directory while IntelliJ uses the directory of the root project.

The only really safe way to solve this problem is to load via the classpath. Is this a possibility for your scenario?
____

I realized that I should not write unit tests which depend on the "current working directory".

=== Temporary output files shouldn't be located into the project's directory

The easiest way to locate an output file from a unit-test is to call `java.io.File("some-file.txt")` or `java.nio.Paths("some-file.txt")`. Then the `some-file.txt` will be located under the current working directory = `System.getProperty("user.dir")`. Using Maven and Gradle, the current working directory will usually be equal to the project's directory. By calling `java.io.File(relative path)` often, you will get a lot of temporary files located in the project directory, like this.

[source]
----
.
├── 2023.10.24_22.07.27.742-7440524241d0dbd63ca5eec377b6455c.png    --- x
├── 2023.10.24_22.07.29.333-7440524241d0dbd63ca5eec377b6455c.png    --- x
├── build
│   ├── allure-results
│   ├── classes
│   ├── downloads
│   ├── generated
│   ├── reports
│   ├── resources
│   ├── test-results
│   └── tmp
├── build.gradle
├── extentReport.html    --- x
├── fullpage-screenshot-chrome.png    --- x
├── gradle
│   └── wrapper
├── gradlew
├── gradlew.bat
├── login.har    --- x
├── my-pdf.pdf    --- x
├── pom.xml
├── screenshot.png    --- x
├── src
│   ├── main
│   └── test
├── target
│   ├── classes
│   ├── generated-sources
│   ├── generated-test-sources
│   ├── maven-status
│   └── test-classes
├── testAccessibility.json    --- x
├── webdrivermanager.pdf    --- x
├── webdrivermanager.png    --- x
└── webelement-screenshot.png    --- x

20 directories, 15 files
----
Here the files labeled with "--- x" are the temporary output files created by the unit-tests.

Temporary files located in the project directory make the project tree dirty. The files scattered in the project directory are difficult to manage. If you want to remove them, you have to choose each files and delete them one by one manually.

Rather, I want to create a dedicated directory where all test classes should write their output into. I would list it in the `.gitignore` file to exclude the temporary files out of the git repository.

== Solution

This project provides a Java class link:https://github.com/kazurayam/unittest-helper/blob/develop/lib/src/main/java/com/kazurayam/unittest/TestOutputOrganizer.java[`com.kazurayam.unittest.TestOutputOrganizer`].

The `TestOutputOrganizer` helps your unit tests to save files into a dedicated directory in the Maven/Gradle project. Using this class, you can easily prepare a directory into which your unit tests can write files. The location of the output directory is resolved via the classpath of the unit-test class. The `TestOutputOrganizer` does ot depend on the value returned by `System.getProperty("user.dir")`.

The `TestOutputOrgainzer` class is independent on the type of unit-testing frameworks you choose: JUnit4, JUnit5 and TestNG.

The `TestOutputOrgainzer` class is compiled by Java8.

Using the `TestOutputOrganizer` class, you can well-organize the files created by test classes, as follows:

image::https://kazurayam.github.io/unittest-helper/images/well-organized-test-outputs.png[well organized test outputs]

== How does the `TestOutputOrganizer` resolves the project root directory ?


The `getProject()` method of `TestOutputOrganizer` class internally works as follows.

1. The constructor call `new TestOutputOrganizer.Builder(this.getClass())` tells it should look at the code source of `this` object, which is `/Users/kazurayam/github/unittest-helper/app/build/classes/java/test/com/kazurayam/unittestshelperdemo/OrganizerPresentTest.class`.
2. The `TestOutputOrganizer` internally tries to find out which build tool you used: Maven or Gradle?
If you used Maven, it expects that the project directory to have a subdirectory `target/test-classes`. If the `TestOutputOrganizer` found `target/test-classes` in the code source path, then the parent directory of the `target` directory is presumed to be the project directory.
If you use Gradle, the `TestOutputOrganizer` expects that the project directory would have a subdirectory `build/classes/java/test`. So `TestOutputOrganizer` tries to find `build/classes/java/test` in the code source path. When the subdirectory pattern is found in the code source path, then the parent directory of the `build` directory is presumed to be the project dir.


The `com.kazurayam.unittest.ProjectDirectoryResovler` class has a list of the patterns to match against the code source given. You can che check the content of the list. Let me assume you have the following test code:

[source]
----
include::../app/src/test/java/com/kazurayam/unittesthelperdemo/ProjectDirectoryResolverTest.java[]
----

This test prints the following result in the console:

[source]
----
sublistPattern : [target, test-classes]
sublistPattern : [build, classes, java, test]
sublistPattern : [build, classes, groovy, test]
sublistPattern : [build, classes, kotlin, test]
----

The 1st sublistPattern is for Maven. the 2nd, sublistPattern is for Java codes built in Gradle. The 3rd is for Groovy codes built in Gradle. The 4th is for Kotlin codes built in Gradle.

Do you need a unique sublistPattern other than those built-in ones?

OK. You can add more sublistPatterns for your own needs by calling the `TestOutputOrganizer.Builder.sublistPattern(List<String>)` method.



== Description by examples

include::ex01.adoc[]
include::ex02.adoc[]
include::ex03.adoc[]
include::ex04.adoc[]
include::ex05.adoc[]
include::ex06.adoc[]
include::ex07.adoc[]
include::ex08.adoc[]
include::ex09.adoc[]
include::ex10.adoc[]
include::ex11.adoc[]
include::ex12.adoc[]
include::ex13.adoc[]
include::ex14.adoc[]
(FIN)